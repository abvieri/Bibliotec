<!DOCTYPE html>
<html lang="pt-br">

<head>
  <title>Bibliotec</title>
  <link rel="shortcut icon" href="../img/logo.png">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<body onload="Historico()">

  <style>
    #iframe {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      overflow: hidden;
    }
  </style>


  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
  <script src="../firebase-init.js" type="module"></script>

  <script type="module">
    var Selected = window.location.search;
    Selected = decodeURIComponent(Selected);
    Selected = Selected.replace("?selectedbook=", "");

    document.addEventListener("DOMContentLoaded", function () {
      var iframe = document.createElement("iframe");
      const livro = "lib/web/viewer.html?file=livros/" + Selected + ".pdf";

      iframe.setAttribute("height", "100%");
      iframe.setAttribute("width", "100%");
      iframe.setAttribute("id", "iframe");
      iframe.setAttribute("src", livro);

      document.body.appendChild(iframe);
    });

  </script>

  <script>
    var Selected = window.location.search;
    Selected = decodeURIComponent(Selected);
    livroID = Selected.replace("?selectedbook=", "");

    function Historico() {
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          firebase.firestore().collection('users').where('email', '==', user.email).get().then(snapshot => {
            const usuario = snapshot.docs.map(doc => doc.data());

            var a = usuario[0].historico.length;
            if (a <= 0 || a == null || a == undefined) {
              a = 1;
            } else {
              a = usuario[0].historico.length;
            }

            let array = usuario[0].historico;
            array.push(livroID);

            const data = {
              historico: array
            };

            var en = false;
            for (let i = 0; i < a; i++) {
              const element = usuario[0].historico[i];

              if (element == livroID) {
                en = true;
                break;
              }
            }

            if (!en) {
              firebase.firestore().collection('users').doc(snapshot.docs[0].id).update(data);
              console.log("Salvo");
            }

            if (en) {
              firebase.firestore()
                .collection('livros')
                .where('id', '==', livroID)
                .get()
                .then(snapshot => {
                  const transactions = snapshot.docs.map(doc => doc.data());
                  var book = usuario[0].historico;

                  for (let i = 0; i < a; i++) {
                    const element = usuario[0].historico[i];

                    if (transactions[0].id == element) {

                      var encontrado = false;
                      for (var e = 0; e < book.length; e++) {
                        if (book[e] == element) {
                          book[e] = '';
                          encontrado = true;
                        }
                      }

                      if (encontrado) {
                        const remo = {
                          historico: book
                        }

                        Remove(remo);
                      }
                    }
                  }
                })
            }
          })
        }
      })
    }

    function Remove(remo) {
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          firebase.firestore().collection('users').where('email', '==', user.email).get().then(snapshot => {
            firebase.firestore().collection('users').doc(snapshot.docs[0].id).update(remo);
          })
        }

        var arraynotnull = remo.historico.filter(function (i) {
          return i;
        });

        const rem = {
          historico: arraynotnull
        };

        firebase.firestore().collection('users').where('email', '==', user.email).get().then(snapshot => {
          firebase.firestore().collection('users').doc(snapshot.docs[0].id).update(rem);
        })
      })
    }

  </script>
</body>

</html>